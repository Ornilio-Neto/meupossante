{% extends "base.html" %}
{% block title %}Cadastros e Par√¢metros{% endblock %}

{% block content %}

{# ========================
   VARI√ÅVEIS SEGURAS
   ======================== #}
{% set p = parametro if parametro else None %}
{% set periodicidade = p.periodicidade_meta if p else '' %}
{% set tipo_meta = p.tipo_meta if p else '' %}

<div class="container mt-4">
  <h1 class="mb-4">Configura√ß√µes e Cadastros</h1>

  <!-- Mensagens Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Par√¢metros Gerais -->
  <div class="card mb-4">
    <div class="card-header">
      <h3>Par√¢metros Gerais</h3>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('main.cadastro') }}">
        <input type="hidden" name="form_name" value="parametros">

        <div class="row g-3">

          <div class="col-md-6">
            <label class="form-label">Modelo do Carro</label>
            <input type="text" class="form-control" name="modelo_carro"
                   value="{{ p.modelo_carro if p else '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">Placa</label>
            <input type="text" class="form-control" name="placa_carro"
                   value="{{ p.placa_carro if p else '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">KM Atual</label>
            <input type="number" class="form-control" name="km_atual"
                   value="{{ p.km_atual if p else '' }}" {{ 'readonly' if not is_initial_setup else '' }}>
            <small class="form-text text-muted">
                {% if is_initial_setup %}
                    Insira o KM atual do seu ve√≠culo. Ap√≥s o primeiro abastecimento, este campo ser√° atualizado automaticamente.
                {% else %}
                    Atualizado automaticamente pela p√°gina de abastecimento.
                {% endif %}
            </small>
          </div>

          <div class="col-md-6">
            <label class="form-label">M√©dia de Consumo (Km/L)</label>
            <input type="text" inputmode="decimal" class="form-control" name="media_consumo"
                   value="{{ '%.2f'|format(p.media_consumo) if p else '' }}" {{ 'readonly' if not is_initial_setup else '' }}>
            <small class="form-text text-muted">
                {% if is_initial_setup %}
                    Insira a m√©dia de consumo inicial (ex: 12.5). Ap√≥s os abastecimentos, ser√° recalculado.
                {% else %}
                    Calculado automaticamente a partir dos abastecimentos com tanque cheio.
                {% endif %}
            </small>
          </div>

          <hr class="my-4">

          <div class="col-md-6">
            <label class="form-label">Dias de Trabalho na Semana</label>
            <input type="number" class="form-control" name="dias_trabalho_semana"
                   value="{{ p.dias_trabalho_semana if p else '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">Meta de Faturamento</label>
            <input type="text" inputmode="decimal" class="form-control" name="meta_faturamento"
                   value="{{ '%.2f'|format(p.meta_faturamento) if p else '' }}">
          </div>

          <!-- Periodicidade da Meta -->
          <div class="col-md-6">
            <label class="form-label">Periodicidade da Meta</label>
            <select class="form-select" name="periodicidade_meta">
              <option value="diaria" {{ 'selected' if periodicidade == 'diaria' else '' }}>Di√°ria</option>
              <option value="semanal" {{ 'selected' if periodicidade == 'semanal' else '' }}>Semanal</option>
              <option value="mensal" {{ 'selected' if periodicidade == 'mensal' else '' }}>Mensal</option>
            </select>
          </div>

         <!-- Tipo da Meta -->
         <div class="col-md-6">
           <label class="form-label">Tipo da Meta</label>
           <select class="form-select" name="tipo_meta">
             <option value="bruta" {{ 'selected' if tipo_meta == 'bruta' else '' }}>
               Bruta (Faturamento Total)
             </option>
             <option value="liquida" {{ 'selected' if tipo_meta == 'liquida' else '' }}>
               L√≠quida (Faturamento - Custos Vari√°veis)
             </option>
           </select>
         </div>
         
         <hr class="my-4">

         <div class="col-md-6">
             <label class="form-label">Valor M√≠nimo por KM (R$)</label>
             <input type="text" inputmode="decimal" class="form-control" name="valor_km_minimo"
                    value="{{ '%.2f'|format(p.valor_km_minimo) if p else '' }}">
             <small class="form-text text-muted">
                 Valor m√≠nimo que voc√™ aceita ganhar por KM rodado. Ajuda a filtrar corridas.
             </small>
         </div>

         <div class="col-md-6">
             <label class="form-label">Meta de Valor por KM (R$)</label>
             <input type="text" inputmode="decimal" class="form-control" name="valor_km_meta"
                    value="{{ '%.2f'|format(p.valor_km_meta) if p else '' }}">
             <small class="form-text text-muted">
                 Sua meta de ganho por KM rodado para atingir seus objetivos.
             </small>
         </div>

        </div>

        <div class="mt-4">
          <button type="submit" name="form_name" value="parametros"
                  class="btn btn-primary">
            Salvar Par√¢metros
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cadastro de Custos -->
  <div class="card mb-4">
    <div class="card-header">
      <h3>Cadastrar Novo Custo Recorrente</h3>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('main.cadastro') }}">
        <input type="hidden" name="form_name" value="custos">
        {{ custo_form.hidden_tag() }}

        <div class="row g-3">
          <div class="col-md-6">
            {{ custo_form.nome.label(class="form-label") }}
            {{ custo_form.nome(class="form-control") }}
          </div>

          <div class="col-md-3">
            {{ custo_form.valor.label(class="form-label") }}
            {{ custo_form.valor(class="form-control", placeholder="Ex: 150,50") }}
          </div>

          <div class="col-md-3">
            {{ custo_form.dia_vencimento.label(class="form-label") }}
            {{ custo_form.dia_vencimento(class="form-control", min=1, max=31) }}
          </div>

          <div class="col-md-12">
            {{ custo_form.observacao.label(class="form-label") }}
            {{ custo_form.observacao(class="form-control") }}
          </div>
        </div>

        <div class="mt-3">
          <button type="submit" class="btn btn-secondary">
            Cadastrar Custo
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Custos -->
  <div class="card">
    <div class="card-header">
      <h3>Custos Recorrentes Cadastrados</h3>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Valor</th>
            <th>Vencimento</th>
            <th class="text-center">Status</th>
            <th>Observa√ß√£o</th>
            <th class="text-center">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for custo in custos %}
            {# Deixa a linha cinza se o custo estiver inativo #}
            <tr class="{% if not custo.is_active %}text-muted{% endif %}">
              <td class="fw-bold">{{ custo.nome }}</td>
              <td>R$ {{ "%.2f"|format(custo.valor) }}</td>
              <td>Dia {{ custo.dia_vencimento }}</td>
              <td class="text-center">
                {# Badge para indicar o status #}
                {% if custo.is_active %}
                  <span class="badge bg-success">Ativo</span>
                {% else %}
                  <span class="badge bg-secondary">Inativo</span>
                {% endif %}
              </td>
              <td>{{ custo.observacao }}</td>
              <td class="text-center text-nowrap">
                <!-- BOT√ÉO DE ATIVAR/DESATIVAR -->
                <form method="POST" action="{{ url_for('main.toggle_custo_active', custo_id=custo.id) }}" style="display:inline">
                  {% if custo.is_active %}
                    <button type="submit" class="btn btn-sm btn-outline-warning" title="Desativar Custo">‚è∏Ô∏è</button>
                  {% else %}
                    <button type="submit" class="btn btn-sm btn-outline-success" title="Ativar Custo">‚ñ∂Ô∏è</button>
                  {% endif %}
                </form>
                
                <!-- Bot√£o de Editar (j√° existente) -->
                <a href="{{ url_for('main.edit_definicao_custo', custo_id=custo.id) }}" class="btn btn-sm btn-outline-primary" title="Editar Custo">‚úèÔ∏è</a>
                
                <!-- Bot√£o de Excluir (j√° existente, com alerta melhorado) -->
                <form method="POST" action="{{ url_for('main.delete_definicao_custo', custo_id=custo.id) }}" style="display:inline" onsubmit="return confirm('ATEN√á√ÉO! Deseja excluir permanentemente este custo e TODOS os seus registros passados e futuros? Esta a√ß√£o n√£o pode ser desfeita.');">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Custo">üóëÔ∏è</button>
                </form>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6" class="text-center">
                Nenhum custo cadastrado.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
