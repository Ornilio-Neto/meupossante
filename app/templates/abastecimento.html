{% extends 'base.html' %}

{% block title %}Diário de Bordo - Abastecimento{% endblock %}

{% block styles %}
<style>
    .form-column {
        background-color: #f8f9fa;
        padding: 2rem;
        border-radius: 0.5rem;
        height: fit-content;
    }
    .history-column {
        height: 85vh;
        overflow-y: auto;
        padding: 1rem;
    }

    /* --- ESTILO PARA SEPARAR OS DIAS --- */
    .day-group {
        margin-bottom: 2rem; 
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #e9ecef; /* Linha separadora */
    }
    .day-group:last-child {
        border-bottom: none; /* Remove a linha do último grupo */
    }

    .day-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        text-transform: capitalize;
        margin-bottom: 1rem;
    }

    .entry-item {
        margin-bottom: 1rem; 
    }
    .entry-item p { 
        margin-bottom: 0.1rem; 
        line-height: 1.4;
    }

    .consumption-highlight {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #e6f9f0;
        border-radius: .3rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="row gx-lg-5">
    <!-- Coluna do Formulário (RESTAURADA) -->
    <div class="col-lg-5">
        <div class="form-column">
            <h2 class="text-center mb-4">Lançar Abastecimento</h2>
            <form method="POST" id="abastecimentoForm" novalidate>
                <div class="mb-3"><label for="data" class="form-label">Data</label><input type="date" class="form-control" id="data" name="data" value="{{ hoje }}" required></div>
                <div class="mb-3"><label for="kmAtual" class="form-label">KM Atual</label><input type="number" class="form-control" id="kmAtual" name="kmAtual" required><div class="form-text">Último KM: <strong>{{ parametro.km_atual if parametro else 'N/A' }}</strong></div></div>
                <div class="row">
                    <div class="col-md-4 mb-3"><label for="precoPorLitro">Preço/L</label><input type="number" step="0.001" class="form-control" id="precoPorLitro" name="precoPorLitro"></div>
                    <div class="col-md-4 mb-3"><label for="litros">Litros</label><input type="number" step="0.01" class="form-control" id="litros" name="litros"></div>
                    <div class="col-md-4 mb-3"><label for="custoTotal">Custo Total</label><input type="number" step="0.01" class="form-control" id="custoTotal" name="custoTotal"></div>
                </div>
                <div class="mb-3"><label for="tipoCombustivel">Combustível</label><select class="form-select" id="tipoCombustivel" name="tipoCombustivel" required>{% for tipo in tipos_combustivel %}<option value="{{ tipo.id }}">{{ tipo.nome }}</option>{% endfor %}<option value="add_new_combustivel">+ Adicionar Novo</option></select></div>
                <div class="mb-3 d-none" id="newCombustivelWrapper"><label for="newCombustivelName">Novo Combustível</label><input type="text" class="form-control" id="newCombustivelName" name="newCombustivelName"></div>
                <div class="form-check form-switch mb-4"><input class="form-check-input" type="checkbox" id="tanqueCheio" name="tanqueCheio"><label class="form-check-label" for="tanqueCheio">Encheu o tanque</label></div>
                <div class="d-grid"><button type="submit" class="btn btn-primary btn-lg">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Coluna do Histórico (COM SEPARADORES DE DIA) -->
    <div class="col-lg-7">
        <div class="history-column">
            {% if historico %}
                {% for group in historico|groupby('data') %}
                    <div class="day-group">
                        <div class="day-header">{{ group.grouper.strftime('%A, %d de %B de %Y') }}</div>
                        
                        {% for abs in group.list %}
                            <div class="entry-item">
                                <p><strong>{{ abs.tipo_combustivel.nome }}</strong></p>
                                <p>{{ abs.litros | round(2) }} litros</p>
                                <p><strong>KM:</strong> {{ abs.km_atual }}</p>
                                <p><strong>Preço/L:</strong> R$ {{ "%.3f"|format(abs.preco_por_litro) }}</p>
                                <p><strong>Total:</strong> R$ {{ "%.2f"|format(abs.custo_total) }}</p>

                                {% if abs.media_desde_anterior %}
                                <div class="consumption-highlight">
                                    Média do Trecho: {{ "%.2f"|format(abs.media_desde_anterior) }} km/L
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center p-5 text-muted">
                    <i class="bi bi-journal-richtext fs-1"></i>
                    <p class="mt-3">Nenhum abastecimento registrado.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('tipoCombustivel').addEventListener('change', function() {
        var wrapper = document.getElementById('newCombustivelWrapper');
        if (this.value === 'add_new_combustivel') {
            wrapper.classList.remove('d-none');
        } else {
            wrapper.classList.add('d-none');
        }
    });
</script>
{% endblock %}