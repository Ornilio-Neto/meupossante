{% extends 'base.html' %} {% block title %}Diário de Bordo - Abastecimento{%
endblock %} {% block styles %}
<style>
  .form-column {
    background-color: #f8f9fa;
    padding: 2rem;
    border-radius: 0.5rem;
    height: fit-content;
  }
  .history-column {
    height: 85vh;
    overflow-y: auto;
    padding: 1rem;
  }
  .day-group {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #e9ecef;
  }
  .day-group:last-child {
    border-bottom: none;
  }
  .day-header {
    font-size: 1.1rem;
    font-weight: 600;
    color: #495057;
    text-transform: capitalize;
    margin-bottom: 1rem;
  }
  .entry-item {
    margin-bottom: 1rem;
  }
  .entry-item p {
    margin-bottom: 0.1rem;
    line-height: 1.4;
  }

  .stretch-consumption-highlight {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.3rem;
    font-size: 0.9rem;
  }

  .period-consumption-highlight {
    margin-top: 0.8rem;
    padding: 0.8rem;
    background-color: #e6f9f0;
    border: 1px solid #b8e0c5;
    border-radius: 0.4rem;
    font-weight: 700;
    text-align: center;
    font-size: 1rem;
    color: #0f5132;
  }
  .period-consumption-highlight .bi {
    vertical-align: -0.1em;
  }
</style>
{% endblock %} {% block content %}
<div class="row gx-lg-5">
  <div class="col-lg-5">
    <!-- Coluna do Formulário -->
    <div class="form-column">
      <h2 class="text-center mb-4">Lançar Abastecimento</h2>
      <form method="POST" id="abastecimentoForm" novalidate>
        <div class="mb-3">
          <label for="data" class="form-label">Data</label
          ><input
            type="date"
            class="form-control"
            id="data"
            name="data"
            value="{{ hoje }}"
            required
          />
        </div>
        <div class="mb-3">
          <label for="kmAtual" class="form-label">KM Atual</label
          ><input
            type="number"
            class="form-control"
            id="kmAtual"
            name="kmAtual"
            required
          />
          <div class="form-text">
            Último KM:
            <strong>{{ parametro.km_atual if parametro else 'N/A' }}</strong>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="precoPorLitro">Preço/L</label
            ><input
              type="text"
              inputmode="decimal"
              class="form-control"
              id="precoPorLitro"
              name="precoPorLitro"
            />
          </div>
          <div class="col-md-4 mb-3">
            <label for="litros">Litros</label
            ><input
              type="text"
              inputmode="decimal"
              class="form-control"
              id="litros"
              name="litros"
            />
          </div>
          <div class="col-md-4 mb-3">
            <label for="custoTotal">Custo Total</label
            ><input
              type="text"
              inputmode="decimal"
              class="form-control"
              id="custoTotal"
              name="custoTotal"
            />
          </div>
        </div>
        <div class="mb-3">
          <label for="tipoCombustivel" class="form-label">Combustível</label
          ><select
            class="form-select"
            id="tipoCombustivel"
            name="tipoCombustivel"
            required
          >
            <option value="" selected disabled hidden>Selecione...</option>
            {% for tipo in tipos_combustivel %}
            <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
            {% endfor %}
            <option value="add_new_combustivel">+ Adicionar Novo</option>
          </select>
        </div>
        <div class="mb-3 d-none" id="newCombustivelWrapper">
          <label for="newCombustivelName">Novo Combustível</label
          ><input
            type="text"
            class="form-control"
            id="newCombustivelName"
            name="newCombustivelName"
          />
        </div>
        <div class="form-check form-switch mb-4">
          <input
            class="form-check-input"
            type="checkbox"
            id="tanqueCheio"
            name="tanqueCheio"
          /><label class="form-check-label" for="tanqueCheio"
            >Encheu o tanque</label
          >
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-7">
    <!-- Coluna do Histórico -->
    <div class="history-column">
      {% if historico %} {% for group in historico|groupby('data') %}
      <div class="day-group">
        <div class="day-header">
          {{ group.grouper.strftime('%A, %d de %B de %Y') }}
        </div>
        {% for abs in group.list %}
        <div class="entry-item p-3 border rounded">
          <p>
            <strong
              >{{ abs.tipo_combustivel.nome if abs.tipo_combustivel else
              'Combustível não informado' }}</strong
            >
          </p>
          <p>{{ abs.litros | round(2) }} litros</p>
          <p><strong>KM:</strong> {{ abs.km_atual }}</p>
          <p>
            <strong>Preço/L:</strong> R$ {{ "%.3f"|format(abs.valor_litro) }}
          </p>
          <p><strong>Total:</strong> R$ {{ "%.2f"|format(abs.valor_total) }}</p>

          {% if abs.media_consumo_calculada %}
          <div class="period-consumption-highlight">
            <i class="bi bi-fuel-pump-fill"></i> Média Real do Período:
            <strong
              >{{ "%.2f"|format(abs.media_consumo_calculada) }} km/L</strong
            >
          </div>
          {% endif %} {% if abs.media_desde_anterior %}
          <div class="stretch-consumption-highlight">
            Média do Trecho: {{ "%.2f"|format(abs.media_desde_anterior) }} km/L
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endfor %} {% else %}
      <div class="text-center p-5 text-muted">
        <i class="bi bi-journal-richtext fs-1"></i>
        <p class="mt-3">Nenhum abastecimento registrado.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Calculation Logic ---
    const precoInput = document.getElementById("precoPorLitro");
    const litrosInput = document.getElementById("litros");
    const totalInput = document.getElementById("custoTotal");

    function formatAndCalculate(event) {
      let value = event.target.value;
      // Allow only numbers and one comma/dot
      value = value.replace(/[^\d,.]/g, "").replace(",", ".");

      // Update the value in the field
      // event.target.value = value;

      const preco = parseFloat(precoInput.value.replace(",", ".")) || 0;
      const litros = parseFloat(litrosInput.value.replace(",", ".")) || 0;
      const total = parseFloat(totalInput.value.replace(",", ".")) || 0;

      const activeElement = document.activeElement;

      if (activeElement === precoInput && litros > 0) {
        totalInput.value = (preco * litros).toFixed(2).replace(".", ",");
      } else if (activeElement === litrosInput && preco > 0) {
        totalInput.value = (preco * litros).toFixed(2).replace(".", ",");
      } else if (activeElement === totalInput) {
        if (preco > 0) {
          litrosInput.value = (total / preco).toFixed(2).replace(".", ",");
        } else if (litros > 0) {
          precoInput.value = (total / litros).toFixed(3).replace(".", ",");
        }
      }
    }

    [precoInput, litrosInput, totalInput].forEach((input) => {
      input.addEventListener("input", formatAndCalculate);
    });

    // --- New Fuel Logic ---
    const tipoCombustivelSelect = document.getElementById("tipoCombustivel");
    const newCombustivelWrapper = document.getElementById(
      "newCombustivelWrapper",
    );
    const newCombustivelInput = document.getElementById("newCombustivelName");

    function toggleNewFuelField() {
      if (tipoCombustivelSelect.value === "add_new_combustivel") {
        newCombustivelWrapper.classList.remove("d-none");
        newCombustivelInput.required = true;
      } else {
        newCombustivelWrapper.classList.add("d-none");
        newCombustivelInput.required = false;
        newCombustivelInput.value = "";
      }
    }

    tipoCombustivelSelect.addEventListener("change", toggleNewFuelField);

    // Initial check on page load
    toggleNewFuelField();
  });
</script>
{% endblock %}
